<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <head th:replace="~{fragments/head :: page-head(title='Business Reports')}"></head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .expense-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body class="app-bg"> <div th:replace="~{fragments/header :: page-header}"></div>

<main>
    <div class="container glass-container"> <h2>Business Reports Dashboard</h2>
        <p>Welcome, <strong sec:authentication="name">User</strong>. Use the filters below to generate a report.</p>

        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

        <div class="form-container date-range-form">
            <h4>Select Date Range</h4>
            <form th:action="@{/reports}" method="get" class="form-grid">
                <div>
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" name="startDate" th:value="${startDate}" required>
                </div>
                <div>
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" name="endDate" th:value="${endDate}" required>
                </div>
                <button type="submit" class="btn">Generate Report</button>
            </form>
        </div>

        <div class="grid-container">
            <div class="form-container">
                <h3>Financial Summary</h3>
                <h4 style="color: #27ae60;">Total Income: <span th:text="'$' + ${#numbers.formatDecimal(totalIncome, 1, 2)}"></span></h4>
                <h4 style="color: #e74c3c;">Total Expenses: <span th:text="'$' + ${#numbers.formatDecimal(totalExpenses, 1, 2)}"></span></h4>
                <hr style="border-color: rgba(255,255,255,0.1);"/>
                <h3 th:style="${netProfit >= 0 ? 'color: #27ae60;' : 'color: #e74c3c;'}">
                    Net Profit: <span th:text="'$' + ${#numbers.formatDecimal(netProfit, 1, 2)}"></span>
                </h3>
            </div>
            <div class="form-container">
                <h3>Income vs. Expenses</h3>
                <canvas id="incomeVsExpenseChart"></canvas>
            </div>

            <div class="form-container">
                <h3>Record Manual Expense</h3>
                <form th:action="@{/reports/expense/add}" method="post">
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" name="description" required>
                    </div>
                    <div class="expense-form-grid">
                        <div class="form-group">
                            <label for="amount">Amount ($)</label>
                            <input type="number" step="0.01" id="amount" name="amount" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseDate">Expense Date</label>
                            <input type="date" id="expenseDate" name="expenseDate" th:value="${#temporals.format(endDate, 'yyyy-MM-dd')}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="category">Category</label>
                        <input type="text" id="category" name="category" placeholder="e.g., Rent, Utilities, Transport" required>
                    </div>
                    <button type="submit" class="btn">Save Expense</button>
                </form>
            </div>
        </div>

        <div class="grid-container">
            <div class="form-container">
                <h4>Fast-Moving Items (Best Sellers)</h4>
                <table class="user-table">
                    <thead><tr><th>Item Name</th><th>Total Quantity Sold</th></tr></thead>
                    <tbody>
                    <tr th:each="item : ${fastMovingItems}" th:if="${item.totalQuantity > 0}">
                        <td th:text="${item.itemName}"></td>
                        <td th:text="${item.totalQuantity}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(fastMovingItems)}">
                        <td colspan="2" style="text-align: center;">No sales data for this period.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="form-container">
                <h4>Slow-Moving Items (Worst Sellers)</h4>
                <table class="user-table">
                    <thead><tr><th>Item Name</th><th>Total Quantity Sold</th></tr></thead>
                    <tbody>
                    <tr th:each="item : ${slowMovingItems}" th:if="${item.totalQuantity > 0}">
                        <td th:text="${item.itemName}"></td>
                        <td th:text="${item.totalQuantity}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(slowMovingItems)}">
                        <td colspan="2" style="text-align: center;">No sales data for this period.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: page-footer}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", function() {
        const totalIncome = /*[[${totalIncome}]]*/ 0;
        const totalExpenses = /*[[${totalExpenses}]]*/ 0;
        const ctx = document.getElementById('incomeVsExpenseChart').getContext('2d');

        // Make Chart.js text white for dark theme
        Chart.defaults.color = '#ecf0f1';

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Total Income', 'Total Expenses'],
                datasets: [{
                    data: [totalIncome, totalExpenses],
                    backgroundColor: ['#27ae60', '#e74c3c'],
                }]
            },
            options: { responsive: true }
        });
    });
    /*]]>*/
</script>

</body>
</html>