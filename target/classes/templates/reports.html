<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <head th:replace="~{fragments/head :: page-head(title='Business Reports')}"></head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .expense-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        /* Style for the new log section */
        .log-text-success { color: #27ae60; }
        .log-text-danger { color: #e74c3c; }
        .sort-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="app-bg"> <div th:replace="~{fragments/header :: page-header}"></div>

<main>
    <div class="container glass-container"> <h2>Business Reports Dashboard</h2>
        <p>Welcome, <strong sec:authentication="name">User</strong>. Use the filters below to generate a report.</p>

        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

        <div class="form-container" style="margin-bottom: 30px;">
            <h3>Record Manual Expense</h3>
            <form th:action="@{/reports/expense/add}" method="post">
                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text" id="description" name="description" required>
                </div>
                <div class="expense-form-grid">
                    <div class="form-group">
                        <label for="amount">Amount ($)</label>
                        <input type="number" step="0.01" id="amount" name="amount" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">Expense Date</label>
                        <input type="date" id="expenseDate" name="expenseDate" th:value="${#temporals.format(endDate, 'yyyy-MM-dd')}" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <input type="text" id="category" name="category" placeholder="e.g., Rent, Utilities, Transport" required>
                </div>
                <button type="submit" class="btn">Save Expense</button>
            </form>
        </div>


        <div class="form-container date-range-form">
            <h4>Select Date Range</h4>
            <form th:action="@{/reports}" method="get" class="form-grid">
                <div>
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" name="startDate" th:value="${startDate}" required>
                </div>
                <div>
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" name="endDate" th:value="${endDate}" required>
                </div>
                <button type="submit" class="btn">Generate Report</button>
            </form>
        </div>

        <div class="grid-container">
            <div class="form-container">
                <h3>Financial Summary</h3>
                <h4 class="log-text-success">Total Income: <span th:text="'$' + ${#numbers.formatDecimal(totalIncome, 1, 2)}"></span></h4>
                <h4 class="log-text-danger">Total Expenses: <span th:text="'$' + ${#numbers.formatDecimal(totalExpenses, 1, 2)}"></span></h4>
                <hr style="border-color: rgba(255,255,255,0.1);"/>
                <h3 th:style="${netProfit >= 0 ? 'color: #27ae60;' : 'color: #e74c3c;'}">
                    Net Profit: <span th:text="'$' + ${#numbers.formatDecimal(netProfit, 1, 2)}"></span>
                </h3>
            </div>
            <div class="form-container">
                <h3>Income vs. Expenses</h3>
                <canvas id="incomeVsExpenseChart"></canvas>
            </div>
        </div>

        <div class="form-container">
            <h3>Detailed Logs</h3>
            <div class="sort-buttons">
                <button id="sort-type-btn" class="btn btn-secondary" onclick="sortTable('type')">Filter Type: All</button>
                <button id="sort-date-btn" class="btn btn-secondary" onclick="sortTable('date')">Sort by Date: Newest</button>
                <button id="sort-value-btn" class="btn btn-secondary" onclick="sortTable('value')">Sort by Value: High</button>
            </div>
            <table class="user-table">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Amount</th>
                </tr>
                </thead>
                <tbody id="logs-tbody">
                </tbody>
            </table>
        </div>

    </div>
</main>

<div th:replace="~{fragments/footer :: page-footer}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // --- Chart.js ---
    document.addEventListener("DOMContentLoaded", function() {
        const totalIncome = /*[[${totalIncome}]]*/ 0;
        const totalExpenses = /*[[${totalExpenses}]]*/ 0;
        const ctx = document.getElementById('incomeVsExpenseChart').getContext('2d');
        Chart.defaults.color = '#ecf0f1';
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Total Income', 'Total Expenses'],
                datasets: [{
                    data: [totalIncome, totalExpenses],
                    backgroundColor: ['#27ae60', '#e74c3c'],
                }]
            },
            options: { responsive: true }
        });

        // --- New Detailed Log Table Logic ---
        renderLogTable();
    });

    // --- Detailed Log Sorting & Rendering ---
    const allLogs = /*[[${detailedLogs}]]*/ [];
    let logSortState = {
        type: 'all', // 'all', 'income', 'expense'
        date: 'desc', // 'desc', 'asc'
        value: 'desc' // 'desc', 'asc'
    };

    function sortTable(criteria) {
        const typeBtn = document.getElementById('sort-type-btn');
        const dateBtn = document.getElementById('sort-date-btn');
        const valueBtn = document.getElementById('sort-value-btn');

        if (criteria === 'type') {
            if (logSortState.type === 'all') logSortState.type = 'income';
            else if (logSortState.type === 'income') logSortState.type = 'expense';
            else logSortState.type = 'all';
            typeBtn.textContent = `Filter Type: ${logSortState.type.charAt(0).toUpperCase() + logSortState.type.slice(1)}`;
        }
        if (criteria === 'date') {
            logSortState.date = logSortState.date === 'desc' ? 'asc' : 'desc';
            dateBtn.textContent = `Sort by Date: ${logSortState.date === 'desc' ? 'Newest' : 'Oldest'}`;
        }
        if (criteria === 'value') {
            logSortState.value = logSortState.value === 'desc' ? 'asc' : 'desc';
            valueBtn.textContent = `Sort by Value: ${logSortState.value === 'desc' ? 'High' : 'Low'}`;
        }

        renderLogTable(criteria);
    }

    function renderLogTable(lastSortCriteria) {
        const tbody = document.getElementById('logs-tbody');
        tbody.innerHTML = ''; // Clear table

        let logsToRender = allLogs;
        if (logSortState.type !== 'all') {
            logsToRender = allLogs.filter(log => log.type.toLowerCase() === logSortState.type);
        }

        logsToRender.sort((a, b) => {
            if (lastSortCriteria === 'date' || lastSortCriteria === undefined) {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return logSortState.date === 'desc' ? dateB - dateA : dateA - dateB;
            }
            if (lastSortCriteria === 'value') {
                return logSortState.value === 'desc' ? b.amount - a.amount : a.amount - b.amount;
            }
            return 0;
        });

        if (logsToRender.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No log data found for this period or filter.</td></tr>';
            return;
        }

        logsToRender.forEach(log => {
            const row = document.createElement('tr');
            const typeClass = log.type === 'Income' ? 'log-text-success' : 'log-text-danger';
            const formattedAmount = '$' + log.amount.toFixed(2);
            row.innerHTML = `
                <td>${log.date}</td>
                <td>${log.description}</td>
                <td class="${typeClass}">${log.type}</td>
                <td class="${typeClass}">${formattedAmount}</td>
            `;
            tbody.appendChild(row);
        });
    }

    /*]]>*/
</script>

</body>
</html>